# This workflow will upload a npm package when a release is created

name: Publish Package to npmjs and PyPi
on:
  release:
    types: [created]
jobs:
  publish-simplay-jupyter-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16.x'
          registry-url: 'https://registry.npmjs.org'
      - name: install & build & publish
        run: |
          cd src/simplay-jupyter 
          npm i
          npm run build
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_JUPYTER_ACCESS_TOKEN }}
  publish-simplay-jupyter-pypi:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.x'
    - name: Wait for simplay to be published
        uses: lewagon/wait-on-check-action@v1.2.0
        with:
          ref: ${{ github.ref }}
          check-name: 'publish simplay'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build
    - name: Build package
      run: |
        cd src/simplay-jupyter
        python -m build
    - name: Publish package
      uses: pypa/gh-action-pypi-publish@27b31702a0e7fc50959f5ad993c78deac1bdfc29
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN_SIMPLAY_JUPYTER }}
        packages_dir: src/simplay-jupyter/dist/
