# This workflow will upload a npm package when a release is created

name: Publish Package to npmjs and PyPi
on:
  release:
    types: [created]
jobs:
  publish-simplay-jupyter-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '16.x'
          registry-url: 'https://registry.npmjs.org'
      - name: install & build & publish
        run: |
          cd src/simplay-jupyter
          npm i
          npm run build
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_JUPYTER_ACCESS_TOKEN }}
  publish-simplay-jupyter-pypi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Base Setup
        uses: jupyterlab/maintainer-tools/.github/actions/base-setup@v1
      - name: Install dependencies
        run: | 
          cd src/simplay-jupyter
          python -m pip install -U jupyterlab~=3.1
      - name: Build the extension
        run: |
          cd src/simplay-jupyter
          set -eux
          python -m pip install .[test]

          jupyter labextension list
          jupyter labextension list 2>&1 | grep -ie "simplay_jupyter.*OK"
          python -m jupyterlab.browser_check
      - name: Package the extension
        run: |
          cd src/simplay-jupyter
          set -eux

          pip install build
          python -m build
          pip uninstall -y "simplay_jupyter" jupyterlab
      - name: Publish package
        uses: pypa/gh-action-pypi-publish@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN_SIMPLAY_JUPYTER }}
          packages_dir: src/simplay-jupyter/dist/
